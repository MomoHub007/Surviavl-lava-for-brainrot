local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Window = Fluent:CreateWindow({
    Title = "MomoHub",
    SubTitle = "Survival lava from Brainrot",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 540),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Brainrot = Window:AddTab({ Title = "Brainrot", Icon = "zap" }),
    Place = Window:AddTab({ Title = "Place", Icon = "package" }),
    Sell = Window:AddTab({ Title = "Sell Brainrot", Icon = "coins" }),
    Rebirth = Window:AddTab({ Title = "Rebirth", Icon = "refresh-cw" }),
    Teleport = Window:AddTab({ Title = "Teleport", Icon = "map-pin" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- ==========================================
-- Variables & Services
-- ==========================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local vim = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer

local gameFolder = workspace:WaitForChild("GameFolder", 10)
local brainrotsFolder = gameFolder and gameFolder:WaitForChild("Brainrots", 5)
local plotsFolder = gameFolder and gameFolder:WaitForChild("Plots", 5)
local raritiesFolder = gameFolder and gameFolder:WaitForChild("Rarities", 5)
local upgradeEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Upgrade")
local sellEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("SellDialogue")

-- States
local AutoClaimEnabled = false
local ClaimDelay = 0.5
local AutoUpgradeBrainrotEnabled = false
local AutoUpgradePlotEnabled = false
local AutoSpeedEnabled = false
local SpeedUpgradeAmount = 10

local AutoCollectEnabled = false
local SelectedCollectMutations = {["Normal"] = true}
local SelectedCollectRarities = {["Common"] = true}

local AutoPlaceEnabled = false
local SelectedPlaceMutations = {["Normal"] = true}
local SelectedPlaceRarities = {["Common"] = true}

local AutoSellEnabled = false
local SelectedSellMutations = {["Normal"] = true}
local SelectedSellRarities = {["Common"] = true}

-- States สำหรับ Rebirth
local AutoCollectRequestEnabled = false
local AutoPlaceRebirthEnabled = false
local AutoRebirthEnabled = false

local RarityPriority = {
    "Celestial", "Secret", "Godly", "Mythic", "Legendary", "Epic", "Rare", "Uncommon", "Common"
}

-- ตาราง Suffix สำหรับ Auto Upgrade Plot
local suffixes = {
    k = 1e3, m = 1e6, b = 1e9, t = 1e12, 
    qd = 1e15, qn = 1e18, sx = 1e21, sp = 1e24, 
    oc = 1e27, no = 1e30, dc = 1e33
}

-- ==========================================
-- Helper Functions
-- ==========================================
local function getMyPlot()
    if not plotsFolder then return nil end
    for _, plot in pairs(plotsFolder:GetChildren()) do
        local success, title = pcall(function() return plot.YourBaseAtt.BillboardGui.Title.Text end)
        if success and (title == "YOUR BASE" or title == "Your Base") then return plot end
    end
    return nil
end

local function checkMutation(obj)
    local attr = obj:GetAttribute("Mutation")
    local valObj = obj:FindFirstChild("Mutation")
    return attr or (valObj and valObj.Value) or "Normal"
end

local function safeParse(val)
    if not val then return 0 end
    local str = tostring(val):gsub("[%$,%s]", ""):lower()
    local oldMultipliers = {k=10^3, m=10^6, b=10^9, t=10^12, qd=10^15, qn=10^18, sx=10^21, sp=10^24, o=10^27}
    for suffix, mult in pairs(oldMultipliers) do
        if str:find(suffix) then
            local numStr = str:match("[%d%.]+")
            if tonumber(numStr) then return tonumber(numStr) * mult end
        end
    end
    return tonumber(str:match("[%d%.]+") or 0) or 0
end

local function parseToNumber(input)
    local text = tostring(input):gsub("[%,%$%s]", "")
    local numberPart = tonumber(string.match(text, "[%d%.]+"))
    local suffixPart = string.match(text, "%a+")
    
    if not numberPart then return 0 end
    if suffixPart then
        local multiplier = suffixes[suffixPart:lower()]
        if multiplier then
            return numberPart * multiplier
        end
    end
    return numberPart
end

local function findBestItemInBackpack()
    for _, rarityName in ipairs(RarityPriority) do
        if SelectedPlaceRarities[rarityName] then
            for _, item in pairs(player.Backpack:GetChildren()) do
                local mutation = item:GetAttribute("Mutation") or "Normal"
                if SelectedPlaceMutations[mutation] then
                    local rarityText = ""
                    local success = pcall(function()
                        rarityText = item.Brainrot.RootPart.BrainrotAtt.BillboardGui.Rarity.Text
                    end)
                    if success and rarityText == rarityName then
                        return item
                    end
                end
            end
        end
    end
    return nil
end

local function getAvailablePlace(myPlot)
    local success, upgradeLabel = pcall(function() return myPlot.Upgrade.Main.SurfaceGui.Upgrade.Upgraded end)
    if not success or not upgradeLabel then return nil end
    
    local currentLevel = tonumber(string.match(upgradeLabel.Text, "%d+")) or 0
    local maxPlaces = currentLevel + 10 

    for i = 1, maxPlaces do
        local id = tostring(i)
        if not myPlot.Brainrots:FindFirstChild(id) and myPlot.Places:FindFirstChild(id) then
            return myPlot.Places[id]
        end
    end
    return nil
end

local function checkAndUpgradePlot()
    if not AutoUpgradePlotEnabled then return end
    local myPlot = getMyPlot()
    if not myPlot then return end

    local cashObj = player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Cash")
    if not cashObj then return end
    local myCash = parseToNumber(cashObj.Value)

    local successLabel, priceLabel = pcall(function() return myPlot.Upgrade.Main.SurfaceGui.Upgrade.Price end)
    if not successLabel or not priceLabel then return end
    
    local upgradePrice = parseToNumber(priceLabel.Text)

    if myCash >= upgradePrice and upgradePrice > 0 then
        pcall(function() upgradeEvent:InvokeServer() end)
    end
end

local function processAutoSell()
    if not AutoSellEnabled then return end
    local backpack = player:FindFirstChild("Backpack")
    if not backpack then return end

    for _, item in pairs(backpack:GetChildren()) do
        local mutation = item:GetAttribute("Mutation") or "Normal"
        
        if SelectedSellMutations[mutation] then
            local rarityText = ""
            local success = pcall(function()
                rarityText = item.Brainrot.RootPart.BrainrotAtt.BillboardGui.Rarity.Text
            end)

            if success and SelectedSellRarities[rarityText] then
                if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
                    player.Character.Humanoid:UnequipTools()
                    task.wait(0.1)
                    item.Parent = player.Character
                    task.wait(0.2)
                    
                    pcall(function()
                        sellEvent:InvokeServer("SellOne")
                    end)
                    
                    task.wait(0.3)
                end
            end
        end
    end
end

-- Helper Functions สำหรับ Rebirth
local function getRebirthTargetName()
    local success, targetName = pcall(function()
        local worldModel = player.PlayerGui.HUD.Rebirth.InsiderFrame.Insider.Brainrots.RebirthReward.ViewportFrame.WorldModel
        local firstObj = worldModel:FindFirstChildOfClass("Model") or worldModel:GetChildren()[1]
        return firstObj and firstObj.Name or nil
    end)
    return success and targetName or nil
end

local function checkTargetInPlot(targetName)
    if not targetName then return false end
    local myPlot = getMyPlot()
    if myPlot and myPlot:FindFirstChild("Brainrots") then
        for _, obj in pairs(myPlot.Brainrots:GetChildren()) do
            if obj.Name == targetName or obj:GetAttribute("Name") == targetName then return true end
            if obj:FindFirstChild(targetName, true) then return true end
            local success, title = pcall(function() return obj.RootPart.BrainrotAtt.BillboardGui.Title.Text end)
            if success and title == targetName then return true end
        end
    end
    return false
end

-- ==========================================
-- Logic Loops
-- ==========================================

-- Combined Loop: Place (Priority) & Collect
task.spawn(function()
    while task.wait(0.5) do
        local myPlot = getMyPlot()
        
        if AutoPlaceEnabled and myPlot then
            local itemToPlace = findBestItemInBackpack()
            local placeSlot = getAvailablePlace(myPlot)
            
            if itemToPlace and placeSlot then
                if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
                    player.Character.Humanoid:UnequipTools()
                    task.wait(0.2)
                end
                
                itemToPlace.Parent = player.Character
                local hrp = player.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local targetCFrame = placeSlot:IsA("Model") and placeSlot:GetPivot() or placeSlot.CFrame
                    hrp.CFrame = targetCFrame * CFrame.new(0, 3, 0)
                    hrp.Anchored = true
                    task.wait(1)
                    hrp.Anchored = false
                    vim:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                    task.wait(3.5)
                    vim:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                    
                end
                continue
            end
        end

        if AutoCollectEnabled and brainrotsFolder then
            local targetObj = nil
            for _, rarityName in ipairs(RarityPriority) do
                if SelectedCollectRarities[rarityName] then
                    local folder = brainrotsFolder:FindFirstChild(rarityName)
                    if folder then
                        for _, obj in pairs(folder:GetChildren()) do
                            local currentMutation = checkMutation(obj)
                            if SelectedCollectMutations[currentMutation] then
                                targetObj = obj
                                break
                            end
                        end
                    end
                end
                if targetObj then break end
            end

            if targetObj and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = player.Character.HumanoidRootPart
                local returnPoint = myPlot and myPlot:GetPivot() or hrp.CFrame
                local targetCFrame = targetObj:IsA("Model") and targetObj:GetPivot() or targetObj.CFrame
                
                local collectPos = targetCFrame * CFrame.new(0, 0, 2.5)
                hrp.CFrame = collectPos
                task.wait(0.2)
                
                vim:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                local startTime = tick()
                while tick() - startTime < 2.8 do
                    if not targetObj or not targetObj.Parent then break end
                    hrp.CFrame = collectPos
                    task.wait(0.01)
                end
                vim:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                task.wait(0.1)
                hrp.CFrame = returnPoint
            end
        end
    end
end)

-- Auto Sell Loop
task.spawn(function()
    while task.wait(0.5) do
        pcall(processAutoSell)
    end
end)

-- Auto Claim
task.spawn(function()
    while true do
        if AutoClaimEnabled then
            local char = player.Character
            local plot = getMyPlot()
            if char and char:FindFirstChild("HumanoidRootPart") and plot then
                local places = plot:FindFirstChild("Places")
                if places then
                    for _, sub in pairs(places:GetChildren()) do
                        local btn = sub:FindFirstChild("Claim")
                        if btn and btn:IsA("BasePart") then
                            firetouchinterest(char.HumanoidRootPart, btn, 0)
                            task.wait(0.01)
                            firetouchinterest(char.HumanoidRootPart, btn, 1)
                        end
                    end
                end
            end
        end
        task.wait(ClaimDelay)
    end
end)

-- Auto Upgrade Brainrot
task.spawn(function()
    while true do
        if AutoUpgradeBrainrotEnabled then
            local myPlot = getMyPlot()
            local leaderstats = player:FindFirstChild("leaderstats")
            local cashObj = leaderstats and (leaderstats:FindFirstChild("Cash") or leaderstats:FindFirstChild("Money"))
            local remote = ReplicatedStorage:FindFirstChild("Events") and ReplicatedStorage.Events:FindFirstChild("Upgrade")
            
            if myPlot and cashObj and remote then
                local myCash = safeParse(cashObj.Value)
                local places = myPlot:FindFirstChild("Places")
                
                if places then
                    for _, sub in pairs(places:GetChildren()) do
                        local priceLabel = sub:FindFirstChild("Price", true)
                        if not priceLabel or not (priceLabel:IsA("TextLabel") or priceLabel:IsA("TextBox")) or priceLabel.Text == "" then
                            continue 
                        end
                        local price = safeParse(priceLabel.Text)
                        if price <= 0 or myCash < price then continue end
                        local upgradeId = tonumber(sub.Name)
                        if upgradeId then
                            pcall(function() remote:InvokeServer(upgradeId) end)
                            myCash = myCash - price 
                        end
                    end
                end
            end
        end
        task.wait(2)
    end
end)

-- Auto Upgrade Plot
task.spawn(function()
    while true do
        pcall(checkAndUpgradePlot)
        task.wait(2)
    end
end)

-- Auto Speed
task.spawn(function()
    while true do
        if AutoSpeedEnabled then
            local remote = ReplicatedStorage:FindFirstChild("Events") and ReplicatedStorage.Events:FindFirstChild("Speed")
            if remote then pcall(function() remote:InvokeServer("Speed", SpeedUpgradeAmount) end) end
        end
        task.wait(0.5)
    end
end)

-- Auto Collect Request
task.spawn(function()
    while task.wait(0.1) do
        if AutoCollectRequestEnabled then
            local targetName = getRebirthTargetName()
            -- เงื่อนไข: ถ้าวางอยู่ในพล็อตแล้ว ข้ามฟังก์ชันนี้ไปเลย
            if targetName and not checkTargetInPlot(targetName) then
                -- เช็คว่าในกระเป๋ามีหรือยัง (ถ้ามีในกระเป๋าแล้วก็ไม่ต้องไปเก็บ)
                local hasInBackpack = player.Backpack:FindFirstChild(targetName) or (player.Character and player.Character:FindFirstChild(targetName))
                
                if not hasInBackpack then
                    local foundTarget = nil
                    if brainrotsFolder then
                        for _, rarityFolder in pairs(brainrotsFolder:GetChildren()) do
                            foundTarget = rarityFolder:FindFirstChild(targetName)
                            if foundTarget then break end
                        end
                    end
                    
                    if foundTarget and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                        local hrp = player.Character.HumanoidRootPart
                        local myPlot = getMyPlot()
                        local returnPoint = myPlot and myPlot:GetPivot() or hrp.CFrame
                        local targetCFrame = foundTarget:IsA("Model") and foundTarget:GetPivot() or foundTarget.CFrame
                        
                        local collectPos = targetCFrame * CFrame.new(0, 0, 2.5)
                        hrp.CFrame = collectPos
                        task.wait(0.2)
                        
                        vim:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                        local startTime = tick()
                        while tick() - startTime < 2.8 do
                            if not foundTarget or not foundTarget.Parent then break end
                            hrp.CFrame = collectPos
                            task.wait(0.01)
                        end
                        vim:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                        task.wait(0.1)
                        hrp.CFrame = returnPoint
                    end
                end
            end
        end
    end
end)

-- Auto Place Brainrot Rebirth
task.spawn(function()
    while task.wait(1) do
        if AutoPlaceRebirthEnabled then
            local targetName = getRebirthTargetName()
            -- เงื่อนไข: ถ้าวางอยู่ในพล็อตแล้ว ข้ามฟังก์ชันนี้ไปเลย
            if targetName and not checkTargetInPlot(targetName) then
                local itemToPlace = player.Backpack:FindFirstChild(targetName)
                if itemToPlace then
                    local myPlot = getMyPlot()
                    local placeSlot = myPlot and getAvailablePlace(myPlot) or nil
                    
                    if placeSlot and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                        player.Character.Humanoid:UnequipTools()
                        task.wait(0.2)
                        itemToPlace.Parent = player.Character
                        
                        local hrp = player.Character.HumanoidRootPart
                        local targetCFrame = placeSlot:IsA("Model") and placeSlot:GetPivot() or placeSlot.CFrame
                        hrp.CFrame = targetCFrame * CFrame.new(0, 3, 0)
                        hrp.Anchored = true
                        task.wait(1)
                        hrp.Anchored = false
                        vim:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                        task.wait(3.5)
                        vim:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                    end
                end
            end
        end
    end
end)

-- [อัปเดตใหม่] Auto Rebirth + ลบ Notifications ขั้นเด็ดขาด
local notificationConnection = nil
task.spawn(function()
    while task.wait(1) do
        if AutoRebirthEnabled then
            -- จัดการ Notifications
            pcall(function()
                local notifications = player.PlayerGui.HUD.Notifications
                if notifications then
                    -- 1. ลบของเก่าที่ค้างอยู่ทิ้ง
                    for _, child in pairs(notifications:GetChildren()) do
                        if not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
                            child:Destroy()
                        end
                    end
                    
                    -- 2. สร้างตัวดักจับ (Event) ลบทิ้งทันทีที่มันถูกสร้างขึ้นมาใหม่ (เคลียร์เด็ดขาด)
                    if not notificationConnection then
                        notificationConnection = notifications.ChildAdded:Connect(function(child)
                            if AutoRebirthEnabled then
                                if not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
                                    child:Destroy()
                                end
                            end
                        end)
                    end
                end
            end)

            -- ส่งคำสั่ง Rebirth
            pcall(function()
                local args = { "Rebirth" }
                ReplicatedStorage:WaitForChild("Events"):WaitForChild("Rebirth"):InvokeServer(unpack(args))
            end)
        else
            -- เคลียร์การเชื่อมต่อทิ้งเมื่อผู้เล่นกดปิด Auto Rebirth
            if notificationConnection then
                notificationConnection:Disconnect()
                notificationConnection = nil
            end
        end
    end
end)

-- ==========================================
-- UI Elements
-- ==========================================

-- Main Tab
Tabs.Main:AddToggle("AutoClaimToggle", { Title = "Auto Claim Money", Default = false, Callback = function(v) AutoClaimEnabled = v end })
Tabs.Main:AddSlider("ClaimDelay", { Title = "Claim Delay", Default = 0.5, Min = 0.5, Max = 2, Rounding = 1, Callback = function(v) ClaimDelay = v end })
Tabs.Main:AddToggle("AutoUpgradePlotToggle", { Title = "Auto Upgrade Plot", Default = false, Callback = function(v) AutoUpgradePlotEnabled = v end })
Tabs.Main:AddToggle("AutoUpgradeBrainrotToggle", { Title = "Auto Upgrade Brainrot", Default = false, Callback = function(v) AutoUpgradeBrainrotEnabled = v end })
Tabs.Main:AddToggle("AutoSpeedToggle", { Title = "Auto Upgrade Speed", Default = false, Callback = function(v) AutoSpeedEnabled = v end })
Tabs.Main:AddDropdown("SpeedAmount", { Title = "Speed Amount", Values = {1, 5, 10}, Default = 10, Callback = function(v) SpeedUpgradeAmount = tonumber(v) end })

-- Brainrot Tab (Collect Only)
Tabs.Brainrot:AddToggle("AutoCollectToggle", { Title = "Enable Auto Collect", Default = false, Callback = function(v) AutoCollectEnabled = v end })
Tabs.Brainrot:AddDropdown("CollectMutationSelect", { Title = "Collect Mutations", Values = {"Normal", "Gold", "Emerald", "Diamond", "Rainbow", "Bloodmoon"}, Multi = true, Default = {"Normal"}, Callback = function(v) SelectedCollectMutations = v end })
Tabs.Brainrot:AddDropdown("CollectRaritySelect", { Title = "Collect Rarities", Values = RarityPriority, Multi = true, Default = {"Common"}, Callback = function(v) SelectedCollectRarities = v end })
Tabs.Brainrot:AddToggle("RemoveLavaToggle", { Title = "Remove All Lava", Default = false, Callback = function(v) if v and gameFolder and gameFolder:FindFirstChild("Lavas") then gameFolder.Lavas:Destroy() end end })
Tabs.Brainrot:AddToggle("RemoveVIPToggle", { Title = "Remove VIP Doors", Default = false, Callback = function(v) if v and gameFolder and gameFolder:FindFirstChild("VIPDoors") then gameFolder.VIPDoors:Destroy() end end })

-- Place Tab
Tabs.Place:AddToggle("AutoPlaceToggle", { Title = "Enable Auto Place", Default = false, Callback = function(v) AutoPlaceEnabled = v end })
Tabs.Place:AddDropdown("PlaceMutationSelect", { Title = "Place Mutations", Values = {"Normal", "Gold", "Emerald", "Diamond", "Rainbow", "Bloodmoon"}, Multi = true, Default = {"Normal"}, Callback = function(v) SelectedPlaceMutations = v end })
Tabs.Place:AddDropdown("PlaceRaritySelect", { Title = "Place Rarities", Values = RarityPriority, Multi = true, Default = {"Common"}, Callback = function(v) SelectedPlaceRarities = v end })

-- Sell Tab
Tabs.Sell:AddToggle("AutoSellToggle", { Title = "Enable Auto Sell", Default = false, Callback = function(v) AutoSellEnabled = v end })
Tabs.Sell:AddDropdown("SellMutationSelect", { Title = "Sell Mutations", Values = {"Normal", "Gold", "Emerald", "Diamond", "Rainbow", "Bloodmoon"}, Multi = true, Default = {"Normal"}, Callback = function(v) SelectedSellMutations = v end })
Tabs.Sell:AddDropdown("SellRaritySelect", { Title = "Sell Rarities", Values = RarityPriority, Multi = true, Default = {"Common"}, Callback = function(v) SelectedSellRarities = v end })

-- Rebirth Tab
Tabs.Rebirth:AddToggle("AutoCollectRequestToggle", { Title = "Auto Collect Request", Default = false, Callback = function(v) AutoCollectRequestEnabled = v end })
Tabs.Rebirth:AddToggle("AutoPlaceRebirthToggle", { Title = "Auto Place Rebirth", Default = false, Callback = function(v) AutoPlaceRebirthEnabled = v end })
Tabs.Rebirth:AddToggle("AutoRebirthToggle", { Title = "Auto Rebirth", Default = false, Callback = function(v) AutoRebirthEnabled = v end })

-- Teleport Tab
if raritiesFolder then
    for _, zone in pairs(raritiesFolder:GetChildren()) do
        Tabs.Teleport:AddButton({ Title = "Go to " .. zone.Name, Callback = function()
            local char = player.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local target = zone:IsA("Model") and (zone.PrimaryPart or zone:FindFirstChildWhichIsA("BasePart", true)) or zone
                if target then char.HumanoidRootPart.CFrame = target.CFrame * CFrame.new(0, 10, 0) end
            end
        end })
    end
end

-- ==========================================
-- Settings System
-- ==========================================
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
InterfaceManager:SetFolder("MoMoHub")
SaveManager:SetFolder("MomoHub/Configs")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()
